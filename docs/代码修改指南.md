# CI/CD ä»£ç ä¿®æ”¹æŒ‡å—

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

ä¸ºäº†ç¡®ä¿ CI/CD åœ¨æœ¬åœ°æ¨¡å‹ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¯¹æµ‹è¯•ä»£ç è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

---

## ğŸ”§ ä¿®æ”¹ 1ï¼šä¼˜åŒ– `tests/test_models.py`

### é—®é¢˜
åŸä»£ç ä½¿ç”¨ `pytestmark` è·³è¿‡æ•´ä¸ªæ–‡ä»¶ï¼Œä½†æœ‰äº›æµ‹è¯•ï¼ˆå¦‚ `test_resolve_dtype`ï¼‰ä¸ä¾èµ–æ¨¡å‹ï¼Œåº”è¯¥åœ¨ CI ä¸­è¿è¡Œã€‚

### ä¿®æ”¹å†…å®¹

**ä¿®æ”¹å‰ï¼š**
```python
# æ•´ä¸ªæ–‡ä»¶è¢«è·³è¿‡
pytestmark = pytest.mark.skipif(
    os.getenv("SKIP_MODEL_LOAD", "false").lower() == "true",
    reason="Skipping model loading tests in CI environment",
)
```

**ä¿®æ”¹åï¼š**
```python
# åªæœ‰éœ€è¦çœŸå®æ¨¡å‹çš„æµ‹è¯•æ‰è·³è¿‡
@pytest.mark.unit
def test_resolve_dtype():
    """æµ‹è¯•æ•°æ®ç±»å‹è§£æå‡½æ•°ï¼ˆä¸ä¾èµ–æ¨¡å‹ï¼‰"""
    # è¿™ä¸ªæµ‹è¯•å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
    ...

@pytest.mark.integration
@pytest.mark.skipif(
    os.getenv("SKIP_MODEL_LOAD", "false").lower() == "true",
    reason="Skipping model loading tests in CI environment",
)
def test_model_manager_load_llm():
    """æµ‹è¯•æ¨¡å‹åŠ è½½ï¼ˆéœ€è¦çœŸå®æ¨¡å‹ï¼Œåªåœ¨æœ¬åœ°è¿è¡Œï¼‰"""
    # è¿™ä¸ªæµ‹è¯•åªåœ¨æœ¬åœ°è¿è¡Œ
    ...
```

### ä¿®æ”¹åŸå› 
- âœ… ä¸ä¾èµ–æ¨¡å‹çš„æµ‹è¯•å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
- âœ… æé«˜æµ‹è¯•è¦†ç›–ç‡
- âœ… æ›´å¿«å‘ç°é—®é¢˜

---

## ğŸ”§ ä¿®æ”¹ 2ï¼šå¢å¼º `tests/conftest.py` çš„ Mock

### é—®é¢˜
åŸ Mock é…ç½®ä¸å¤Ÿå®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´æŸäº›æµ‹è¯•å¤±è´¥ã€‚

### ä¿®æ”¹å†…å®¹

**ä¿®æ”¹å‰ï¼š**
```python
mock_tok = Mock()
mock_tok.pad_token = None
# ç¼ºå°‘ encode å’Œ decode æ–¹æ³•
```

**ä¿®æ”¹åï¼š**
```python
mock_tok = Mock()
mock_tok.pad_token = None
mock_tok.eos_token = "<|eot_id|>"
mock_tok.pad_token_id = 0
mock_tok.eos_token_id = 128001
mock_tok.encode.return_value = [1, 2, 3]  # æ–°å¢
mock_tok.return_value = {"input_ids": Mock(shape=[1, 10])}  # æ–°å¢
```

**åŒæ—¶å¢å¼º `mock_model_manager` fixtureï¼š**
```python
@pytest.fixture
def mock_model_manager():
    """æä¾›å®Œæ•´çš„ mock ModelManager"""
    # åˆ›å»ºå®Œæ•´çš„ mock å¯¹è±¡
    mock_tokenizer = Mock()
    mock_tokenizer.decode.return_value = "Mocked output text"
    # ... æ›´å¤šé…ç½®
    
    with patch.object(ModelManager, "generate", return_value=("Mocked output", 10, 20, 100.0)), \
         patch.object(ModelManager, "moderate", return_value={...}):
        manager = ModelManager()
        yield manager
```

### ä¿®æ”¹åŸå› 
- âœ… æä¾›æ›´å®Œæ•´çš„ Mock å¯¹è±¡
- âœ… é¿å…æµ‹è¯•æ—¶å‡ºç° AttributeError
- âœ… è®©æµ‹è¯•æ›´ç¨³å®š

---

## ğŸ”§ ä¿®æ”¹ 3ï¼šæ”¹è¿› `tests/test_server.py`

### é—®é¢˜
`test_pipeline_endpoint_with_mock` æ²¡æœ‰ä½¿ç”¨ `mock_model_manager` fixtureã€‚

### ä¿®æ”¹å†…å®¹

**ä¿®æ”¹å‰ï¼š**
```python
@pytest.mark.integration
def test_pipeline_endpoint_with_mock():
    """æµ‹è¯• pipeline ç«¯ç‚¹"""
    # æ²¡æœ‰ä½¿ç”¨ mock fixture
    ...
```

**ä¿®æ”¹åï¼š**
```python
@pytest.mark.integration
def test_pipeline_endpoint_with_mock(mock_model_manager):
    """æµ‹è¯• pipeline ç«¯ç‚¹ï¼ˆä½¿ç”¨ mockï¼Œä¸åŠ è½½çœŸå®æ¨¡å‹ï¼‰"""
    # ä½¿ç”¨ mock_model_manager fixture
    ...
```

### ä¿®æ”¹åŸå› 
- âœ… æ˜ç¡®ä½¿ç”¨ Mock å¯¹è±¡
- âœ… æµ‹è¯•æ›´å¯é 
- âœ… é¿å…æ„å¤–åŠ è½½çœŸå®æ¨¡å‹

---

## ğŸ“ å®Œæ•´ä¿®æ”¹æ¸…å•

### æ–‡ä»¶ 1ï¼š`tests/test_models.py`

âœ… **å·²ä¿®æ”¹ï¼š**
- ç§»é™¤äº†æ–‡ä»¶çº§åˆ«çš„ `pytestmark`
- `test_resolve_dtype()` - å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
- `test_get_model_path_fallback()` - å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
- `test_model_manager_singleton()` - å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
- æ–°å¢ `test_model_manager_load_llm()` - åªåœ¨æœ¬åœ°è¿è¡Œ

### æ–‡ä»¶ 2ï¼š`tests/conftest.py`

âœ… **å·²ä¿®æ”¹ï¼š**
- å¢å¼ºäº† `mock_model_loading` fixture
- æ·»åŠ äº† `encode` å’Œ `decode` æ–¹æ³•çš„ Mock
- å¢å¼ºäº† `mock_model_manager` fixture
- æä¾›äº†å®Œæ•´çš„ Mock è¿”å›å€¼

### æ–‡ä»¶ 3ï¼š`tests/test_server.py`

âœ… **å·²ä¿®æ”¹ï¼š**
- `test_pipeline_endpoint_with_mock` ä½¿ç”¨ `mock_model_manager` fixture

---

## ğŸ§ª éªŒè¯ä¿®æ”¹

### æœ¬åœ°æµ‹è¯•ï¼ˆæœ‰æ¨¡å‹ï¼‰

```bash
# ä¸è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨çœŸå®æ¨¡å‹
pytest tests/test_models.py::test_model_manager_load_llm -v
```

### CI æµ‹è¯•ï¼ˆæ— æ¨¡å‹ï¼‰

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ Mock
SKIP_MODEL_LOAD=true pytest tests/ -v
```

**åº”è¯¥çœ‹åˆ°ï¼š**
- âœ… `test_resolve_dtype` é€šè¿‡
- âœ… `test_get_model_path_fallback` é€šè¿‡
- âœ… `test_model_manager_singleton` é€šè¿‡
- â­ï¸ `test_model_manager_load_llm` è·³è¿‡ï¼ˆåœ¨ CI ä¸­ï¼‰

---

## ğŸ¯ ä¿®æ”¹åçš„ä¼˜åŠ¿

### 1. æ›´å¥½çš„æµ‹è¯•è¦†ç›–

- âœ… ä¸ä¾èµ–æ¨¡å‹çš„æµ‹è¯•åœ¨ CI ä¸­è¿è¡Œ
- âœ… æé«˜ä»£ç è¦†ç›–ç‡
- âœ… æ›´å¿«å‘ç°é—®é¢˜

### 2. æ›´ç¨³å®šçš„æµ‹è¯•

- âœ… å®Œæ•´çš„ Mock é…ç½®
- âœ… é¿å… AttributeError
- âœ… æµ‹è¯•æ›´å¯é 

### 3. æ›´æ¸…æ™°çš„æµ‹è¯•åˆ†ç±»

- âœ… å•å…ƒæµ‹è¯•ï¼šCI ä¸­è¿è¡Œ
- âœ… é›†æˆæµ‹è¯•ï¼šæœ¬åœ°è¿è¡Œ
- âœ… æ˜ç¡®æ ‡è®°æµ‹è¯•ç±»å‹

---

## ğŸ“Š æµ‹è¯•è¿è¡Œæƒ…å†µ

### CI ç¯å¢ƒï¼ˆ`SKIP_MODEL_LOAD=true`ï¼‰

```
tests/test_server.py::test_root_endpoint âœ…
tests/test_server.py::test_health_endpoint âœ…
tests/test_server.py::test_pipeline_endpoint_request_validation âœ…
tests/test_server.py::test_moderate_endpoint_request_validation âœ…
tests/test_server.py::test_pipeline_endpoint_with_mock âœ… (ä½¿ç”¨ Mock)

tests/test_models.py::test_resolve_dtype âœ…
tests/test_models.py::test_get_model_path_fallback âœ…
tests/test_models.py::test_model_manager_singleton âœ…
tests/test_models.py::test_model_manager_load_llm â­ï¸ (è·³è¿‡)
```

### æœ¬åœ°ç¯å¢ƒï¼ˆæ—  `SKIP_MODEL_LOAD`ï¼‰

```
æ‰€æœ‰æµ‹è¯•éƒ½è¿è¡Œï¼ŒåŒ…æ‹¬éœ€è¦çœŸå®æ¨¡å‹çš„æµ‹è¯•
```

---

## âœ… æ£€æŸ¥æ¸…å•

ä¿®æ”¹å®Œæˆåï¼Œç¡®ä¿ï¼š

- [x] `tests/test_models.py` - ç§»é™¤äº†æ–‡ä»¶çº§åˆ«çš„ skip
- [x] `tests/conftest.py` - å¢å¼ºäº† Mock é…ç½®
- [x] `tests/test_server.py` - ä½¿ç”¨ mock fixture
- [x] æ‰€æœ‰ä¸ä¾èµ–æ¨¡å‹çš„æµ‹è¯•å¯ä»¥åœ¨ CI ä¸­è¿è¡Œ
- [x] éœ€è¦æ¨¡å‹çš„æµ‹è¯•åœ¨ CI ä¸­æ­£ç¡®è·³è¿‡

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… **æäº¤ä¿®æ”¹**
   ```bash
   git add tests/
   git commit -m "ä¼˜åŒ– CI/CD æµ‹è¯•é…ç½®ï¼Œæ”¯æŒæœ¬åœ°æ¨¡å‹"
   git push origin main
   ```

2. âœ… **æŸ¥çœ‹ CI/CD ç»“æœ**
   - æ‰“å¼€ GitHub â†’ Actions
   - æŸ¥çœ‹æµ‹è¯•æ˜¯å¦é€šè¿‡

3. âœ… **æœ¬åœ°éªŒè¯**
   ```bash
   SKIP_MODEL_LOAD=true pytest tests/ -v
   ```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `tests/test_models.py` - æ¨¡å‹æµ‹è¯•
- `tests/test_server.py` - æœåŠ¡å™¨æµ‹è¯•
- `tests/conftest.py` - Mock é…ç½®
- `.github/workflows/ci.yml` - CI/CD é…ç½®

---

**æ‰€æœ‰ä¿®æ”¹å·²å®Œæˆï¼** ç°åœ¨ä½ çš„ CI/CD å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚ğŸ‰

